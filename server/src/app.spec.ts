import { suite, test } from "@testdeck/jest";
import "reflect-metadata";
import { PanelService } from "./services/panel/panel.service";
import { Lang } from "../../client/src/app/api/models/lang";
import { ActionType, PanelDetails } from "./domain/panel/panel.details";
import { Socket } from "net";
import { Source } from "./domain/panel/panel.contacts";
import { Panel } from "./domain/panel/panel";
import { dumps } from "./domain/panel/initial-damps";
import { app } from "./app";
import { inject } from "strongly";
import { GeneralSettings } from "./domain/panel/settings";

const port = 4000;
const pId = "1"; //'861311009983668'; //'1'//
const host = "localhost"; //'128.199.41.162'; //'178.62.237.25' //'
jest.setTimeout(1000000);
const registerAction = { type: ActionType.status, pId: "1" };
const registerActionString = JSON.stringify(registerAction);
const registerActionD = { type: ActionType.status, pId: "1", d: 1 };
const registerActionStringD = JSON.stringify(registerActionD);

@suite
class AppSpec {
  panelService: PanelService;
  panel: PanelDetails;
  static async before() {
    await app();
  }
  async before() {
    this.panel = { panelId: 1, direction: Lang.en, userId: "1", status: ActionType.idle, phoneNumber: "1" };
    this.panelService = await inject(PanelService);
    // @ts-ignore
    await this.panelService.panelDetailsRepo.collection.deleteMany({});
    // @ts-ignore
    await this.panelService.panelContactsRepo.collection.deleteMany({});
    // @ts-ignore
    await this.panelService.panelSettingsRepo.collection.deleteMany({});

    await this.panelService.addNewPanel(this.panel);
  }
  write = async (str: string) => {
    return new Promise(resolve => {
      const client = new Socket();
      client.setMaxListeners(100);

      client.connect(port, host, function() {
        client.write(str);
        client.on("data", data => {
          client.end();
          client.on("close", () => {
            console.log(data.toString());
            return resolve(data.toString());
          });
        });
      });
    });
  };

  @test
  async statusPanelNotExist() {
    const registerAction = { type: ActionType.status, pId: "-1" };
    const registerActionString = JSON.stringify(registerAction);
    expect(await this.write(registerActionString)).toBe("999");
  }

  @test
  async status() {
    expect(await this.write(registerActionString)).toBe("000");

    this.panel.status = ActionType.readAllFromPanel;
    await this.panelService.saveOrUpdatePanel(this.panel);
    expect(await this.write(registerActionString)).toBe("555");
    expect(await this.write(registerActionStringD)).toBe("000");

    this.panelService.updateContact(1, { index: 0, apartment: "11", name1: "name", tel1: "111", ref: "22" }, [
      { index: 0, previewsValue: "a", source: Source.client, key: "name1" },
      { index: 0, previewsValue: "a", source: Source.client, key: "apartment" },
      { index: 0, previewsValue: "a", source: Source.client, key: "tel1" }
    ]);
    this.panel.status = ActionType.writeToPanel;
    await this.panelService.saveOrUpdatePanel(this.panel);
    expect(await this.write(registerActionString)).toBe("040000002551name"); // name
    expect(await this.write(registerActionStringD)).toBe("04000003563111"); //apartment
    expect(await this.write(registerActionStringD)).toBe("040000036382111"); //tel1
    expect(await this.write(registerActionStringD)).toBe("000");

    this.panelService.updateContact(1, { index: 0, apartment: "11", name1: "name", tel1: "111", ref: "22" }, [
      { index: 0, previewsValue: "a", source: Source.client, key: "name1" },
      { index: 0, previewsValue: "a", source: Source.client, key: "apartment" },
      { index: 0, previewsValue: "a", source: Source.client, key: "tel1" }
    ]);
    this.panel.status = ActionType.writeToPanel;
    await this.panelService.saveOrUpdatePanel(this.panel);
    expect(await this.write(registerActionString)).toBe("040000002551name"); // name
    this.panel.status = ActionType.writeToPanelCanceled;
    await this.panelService.saveOrUpdatePanel(this.panel);
    expect(await this.write(registerActionString)).toBe("RRR");
    expect(await this.write(registerActionStringD)).toBe("000");
  }

  @test
  async statusSettings() {
    await this.panelService.saveOrUpdatePanel(this.panel);

    const p = await this.panelService.getPanel(this.panel);
    p.settings.general.masterCode = "1";
    p.settings.changes = [{ path: "general.masterCode", source: Source.client, previewsValue: "123456" }];

    await this.panelService.updateSettings(1, { general: p.settings.general }, p.settings.changes);
    this.panel.status = ActionType.writeToPanel;
    await this.panelService.saveOrUpdatePanel(this.panel);
    expect(await this.write(registerActionString)).toBe("0400000000311         ");
    expect(await this.write(registerActionStringD)).toBe("000");
  }

  @test
  async readFromPanel() {
    this.panel.status = ActionType.readAllFromPanelCanceled;
    await this.panelService.saveOrUpdatePanel(this.panel);
    const command = "!00000000000000102551555aaaaaaaaaaaa";
    expect(await this.write(registerActionString)).toBe(ActionType.readAllFromPanelCanceled);
    const result = await this.write(command);
    expect(result).toBe("SSS");
    expect(await this.write(registerActionString)).toBe(ActionType.readAllFromPanelCanceled);
    expect(await this.write(registerActionStringD)).toBe(ActionType.idle);

    this.panel.status = ActionType.readAllFromPanel;
    await this.panelService.saveOrUpdatePanel(this.panel);
    expect(await this.write(registerActionString)).toBe(ActionType.readAllFromPanel);
    const result2 = await this.write(command);
    expect(result2).toBe("111");
    expect((await this.panelService.getPanelContacts(1))?.list[0].name1).toBe("aaaaaaaaaaaa");
    const panel = await this.panelService.getPanelDetails(1);
    expect(panel?.status).toBe(ActionType.readAllFromPanelInProgress);

    const result3 = await this.write("!00000000000000102551555aaaa����aaaa    ");
    expect(result3).toBe("111");
    const p = await this.panelService.getPanelContacts(1);
    expect(p?.list[0].name1).toBe("aaaa    aaaa");
    expect(p?.changes[0]).toStrictEqual({ index: 0, key: "name1", source: 0 });

    expect(await this.write(registerActionString)).toBe(ActionType.readAllFromPanelInProgress.toString());
    expect(await this.write(registerActionStringD)).toBe(ActionType.idle);
  }

  @test async writeToPanel() {
    this.panel.status = ActionType.writeAllToPanel;
    await this.panelService.saveOrUpdatePanel(this.panel);
    expect(await this.write(registerActionString)).toBe(ActionType.writeAllToPanel);

    const command = { type: ActionType.writeAllToPanel, pId: "1", data: { start: 2551, length: 10 } };
    const commandString = JSON.stringify(command);
    expect(await this.write(commandString)).toBe("S   APP. # ");
    this.panel.status = ActionType.writeToPanelCanceled;
    await this.panelService.saveOrUpdatePanel(this.panel);
    expect(await this.write(commandString)).toBe(ActionType.writeToPanelCanceled);
  }
  @test
  dumpRedump() {
    const initialPanel = new Panel({
      details: { panelId: 1, userId: "", direction: Lang.he, status: ActionType.idle, phoneNumber: "1" }
    }).reDump(dumps.MP[Lang.he]);
    const dump = initialPanel.dump();
    const expe = dumps.MP.Hebrew;
    const gap = Math.floor(dump.length / 1000);
    expect(dump).toEqual(expe);
    for (let i = 0; i < dump.length; i += gap) {
      console.log(i);
      expect(dump.slice(i, i + gap)).toEqual(expe.slice(i, i + gap));
    }
  }

  // @test
  // async s() {
  //   // const command = "!00000000000000102551555bbaabbbbb";
  //   // const result = await this.write(command);
  //
  //   const registerAction = { type: ActionType.status, pId: "1" };
  //   const registerActionString = JSON.stringify(registerAction);
  //   const registerActionD = { type: ActionType.status, pId: "1", d: 1 };
  //   const registerActionStringD = JSON.stringify(registerActionD);
  //
  //   await this.write(registerActionStringD);
  // }

  // @test async s2() {
  //   "!00000000000000200000555          ";
  //   const dump =
  //     "                               123456    252525    800                           4953                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      עזרא טוינה      תדאור שרות      משרד            יוסי דקל         שאבי                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       04 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249   00050002990330304010081240062010000000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                NYYNNYYYNNYNNYNNNNNYYNNN000004008012016000000000000000000000000000000000000000000000000000000000000000000000000000                                                                                                    14                                                                        000050 002003004005006007008009010011012013014015016017018019020021022023024025026027028029030031032033034035036037038039040041042043044045046047048049050051052053054055056057058059060061062063064065066067068069070071072073074075076077078079080081082083084085086087088089090091092093094095096097098099100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249   20524370907     039226351      039226351      0544450524     039226351                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 05497274180    0524370907     0522506448     0522506448                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0101000101010101030357-     ��������������� ��������������       1200   130                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            2 ";
  //   for (let i = 0; i < 62293; i += 1000) {
  //     const command = `!000000000000002${("00000" + i.toString()).slice(-5)}555${dump.slice(i, i + 1000)}`;
  //     await this.write(command);
  //   }
  //}
}
